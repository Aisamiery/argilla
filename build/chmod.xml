<?xml version="1.0" encoding="UTF-8"?>
<project name="argilla_fixAccessRights" basedir="." default="fixAccessRights">
  <target name="fixAccessRights" description="Set access rights to files and directories">

    <php expression="@posix_getpwuid(stat('.')['uid'])['name']" returnProperty="defaultUser"></php>
    <php expression="@posix_getpwuid(stat('.')['gid'])['name']" returnProperty="defaultGroup"></php>

    <echo message="${defaultUser}"/>
    <echo message="${defaultGroup}"/>

    <input message="Enter user name for change:" propertyName="user" defaultValue="${defaultUser}"/>
    <input message="Enter group name for change:" propertyName="group" defaultValue="${defaultGroup}" />

    <input propertyName="confirm" defaultValue="n" validArgs="y,n" message="Are you sure that want to change owner to ${user}:${group} ?"/>
    <if>
      <equals arg1="${confirm}" arg2="y"/>
      <then>
        <phingcall target="setUser">
          <property name="user" value="${user}" />
          <property name="group" value="${group}" />
        </phingcall>
      </then>
    </if>

    <input propertyName="confirm" defaultValue="n" validArgs="y,n" message="Do fix rights for project?"/>
    <if>
      <equals arg1="${confirm}" arg2="y"/>
      <then>
        <phingcall target="setRight"/>
      </then>
    </if>
  </target>

  <target name="setUser">
    <chown user="${user}" group="${group}" verbose="true" failonerror="false" >
      <fileset dir="." defaultexcludes="false">
        <type type="file"/>
<!--        <exclude name=".git/**"/>
        <exclude name=".git/**/.*"/>-->
        <exclude name="build/node_modules/**"/>
        <exclude name="build/node_modules/**/.*"/>
      </fileset>
      <fileset dir="." defaultexcludes="false">
<!--        <exclude name=".git/**"/>
        <exclude name=".git/**/.*"/>-->
        <exclude name="build/node_modules/**"/>
        <exclude name="build/node_modules/**/.*"/>
      </fileset>
    </chown>
  </target>

  <target name="setRight">
    <chmod mode="0775" verbose="true" file="./index.php" failonerror="false"/>
    <chmod mode="0775" verbose="true" file="backend/index.php"  failonerror="false"/>

    <chmod mode="0664" verbose="true" failonerror="false">
      <fileset dir="." defaultexcludes="false">
        <type type="file"/>
        <exclude name="./f/**"/>
        <exclude name=".git/**"/>
        <exclude name=".git/**/.*"/>
        <exclude name="./build/node_modules/**"/>
        <exclude name="./build/node_modules/**/.*"/>
        <include name="./protected/**/.gitignore" />
        <include name="./backend/protected/**/.gitignore"/>
      </fileset>
    </chmod>

    <chmod mode="0775" verbose="true" failonerror="false">
      <fileset dir="." defaultexcludes="false">
        <type type="dir"/>
        <exclude name="./f/**"/>
        <exclude name=".git/**"/>
        <exclude name=".git/**/.*"/>
        <exclude name="./build/node_modules/**"/>
        <exclude name="./build/node_modules/**/.*"/>
      </fileset>
    </chmod>

    <!-- загружаемые картиночки  -->
    <chmod mode="0777" verbose="true" failonerror="false">
      <fileset dir="./f">
        <type type="dir"/>
      </fileset>
    </chmod>
    <chmod mode="0666" verbose="false" failonerror="false">
      <fileset dir="./f">
        <type type="file"/>
      </fileset>
    </chmod>
    <chmod mode="0664" verbose="true" failonerror="false">
      <fileset dir="./f" defaultexcludes="false">
        <type type="file"/>
        <include name="**/*.gitignore"/>
        <include name="**/*.htaccess"/>
      </fileset>
    </chmod>

    <chmod mode="0777" verbose="true" failonerror="false">
      <fileset dir="assets">
        <type type="dir"/>
      </fileset>
    </chmod>
    <chmod mode="0666" verbose="true" failonerror="false">
      <fileset dir="assets">
        <type type="file"/>
      </fileset>
    </chmod>

    <chmod mode="0777" verbose="true" failonerror="false">
      <fileset dir="./protected/runtime">
        <exclude name="**/.gitignore"></exclude>
      </fileset>
    </chmod>

    <chmod mode="0777" verbose="true" failonerror="false">
      <fileset dir="./backend/protected/runtime">
        <exclude name="**/.gitignore"></exclude>
      </fileset>
    </chmod>

    <!-- git fix -->
    <chmod mode="0775" verbose="false" failonerror="false">
      <fileset dir=".git">
        <type type="dir"/>
      </fileset>
    </chmod>
    <chmod mode="0664" verbose="false" failonerror="false">
      <fileset dir=".git">
        <type type="file"/>
      </fileset>
    </chmod>

    <chmod mode="0775" verbose="true" failonerror="false">
      <fileset dir="protected">
        <type type="file"></type>
        <include name="yiic*"/>
      </fileset>
    </chmod>
  </target>
</project>
